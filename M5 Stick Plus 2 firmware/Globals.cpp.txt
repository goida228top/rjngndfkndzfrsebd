
#include "Globals.h"
#include <WebServer.h>

// --- НАСТРОЙКИ ---
const int SAMPLE_RATE = 16000; // 16kHz - стандарт для API распознавания
const int RECORD_BUFFER_SIZE = 160000; // ~10 секунд записи (16000 * 2 байта * 5 сек = 160000)

// --- ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ---

// Настройки микрофона (по умолчанию)
int mic_gain = 20;       // Ставим поменьше, чтобы не клипповало
int mic_noise_level = 0; // Шумодав выкл по умолчанию
int micSettingsSelection = 0;

// Состояние системы
Mode menuMode;
int selectedItem = 0;
bool isFirstRecording = true;
unsigned long stealth_clock_exit_time = 0;

// Буферы записи
uint8_t* rec_data = nullptr;
size_t recorded_bytes = 0;
uint8_t* last_rec_data = nullptr;
size_t last_recorded_bytes = 0;

// Состояние сообщений
String receivedMessage = "";
// Инициализируем нейтральным контекстом
String lastValidGeminiContext = "Ты ассистент M5Stick."; 

bool newMessageReceived = false;
unsigned long messageTimestamp = 0;
int currentPage = 0;
int totalPages = 0;

// Состояние UI
int messageMenuSelection = 0;
String diagStatusGoogle = (const char*)u8"Ожидание...";
String diagStatusServer = (const char*)u8"Ожидание...";
bool isClockDarkTheme = false;
int clockRotation = 1;

// Пагинация
String pages[MAX_PAGES];

// Сеть
Preferences preferences;
WebServer server(80);

void setMenuMode(Mode newMode) {
    menuMode = newMode;
}

void loadMicSettings() {
    preferences.begin("mic-settings", true); // Read-only
    mic_gain = preferences.getInt("gain", 20); 
    mic_noise_level = preferences.getInt("noise", 0); 
    preferences.end();
}

void saveMicSettings() {
    preferences.begin("mic-settings", false); // RW
    preferences.putInt("gain", mic_gain);
    preferences.putInt("noise", mic_noise_level);
    preferences.end();
}
