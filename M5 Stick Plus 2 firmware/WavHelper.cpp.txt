#include "WavHelper.h"
#include "Globals.h" // For SAMPLE_RATE

void createWavHeader_manual(uint8_t* header, size_t data_size) {
    header[0] = 'R'; header[1] = 'I'; header[2] = 'F'; header[3] = 'F';
    uint32_t file_size = data_size + 36;
    header[4] = (byte)(file_size & 0xFF);
    header[5] = (byte)((file_size >> 8) & 0xFF);
    header[6] = (byte)((file_size >> 16) & 0xFF);
    header[7] = (byte)((file_size >> 24) & 0xFF);
    header[8] = 'W'; header[9] = 'A'; header[10] = 'V'; header[11] = 'E';
    header[12] = 'f'; header[13] = 'm'; header[14] = 't'; header[15] = ' ';
    header[16] = 16; header[17] = 0; header[18] = 0; header[19] = 0;
    header[20] = 1; header[21] = 0; // PCM format
    uint16_t num_channels = 1;
    header[22] = (byte)(num_channels & 0xFF);
    header[23] = (byte)((num_channels >> 8) & 0xFF);
    uint32_t sample_rate = SAMPLE_RATE;
    header[24] = (byte)(sample_rate & 0xFF);
    header[25] = (byte)((sample_rate >> 8) & 0xFF);
    header[26] = (byte)((sample_rate >> 16) & 0xFF);
    header[27] = (byte)((sample_rate >> 24) & 0xFF);
    uint16_t bits_per_sample = 16; // ИСПРАВЛЕНО: Микрофон пишет 16-битный звук
    uint32_t byte_rate = sample_rate * num_channels * (bits_per_sample / 8);
    header[28] = (byte)(byte_rate & 0xFF);
    header[29] = (byte)((byte_rate >> 8) & 0xFF);
    header[30] = (byte)((byte_rate >> 16) & 0xFF);
    header[31] = (byte)((byte_rate >> 24) & 0xFF);
    uint16_t block_align = num_channels * (bits_per_sample / 8);
    header[32] = (byte)(block_align & 0xFF);
    header[33] = (byte)((block_align >> 8) & 0xFF);
    header[34] = (byte)(bits_per_sample & 0xFF);
    header[35] = (byte)((bits_per_sample >> 8) & 0xFF);
    header[36] = 'd'; header[37] = 'a'; header[38] = 't'; header[39] = 'a';
    header[40] = (byte)(data_size & 0xFF);
    header[41] = (byte)((data_size >> 8) & 0xFF);
    header[42] = (byte)((data_size >> 16) & 0xFF);
    header[43] = (byte)((data_size >> 24) & 0xFF);
}