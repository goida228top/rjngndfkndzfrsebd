#include "VoiceToBuzzer.h"
#include <M5StickCPlus2.h>

// --- НАСТРОЙКИ ТОНОВ ---
const int FREQ_A = 523; // C5
const int FREQ_B = 1046; // C6

void handleBuzzerMode() {
    // Статические переменные для отслеживания состояния кнопок/зуммера,
    // чтобы звук не включался/выключался в каждом цикле.
    static bool tone_a_is_playing = false;
    static bool tone_b_is_playing = false;

    // --- ОБРАБОТКА КНОПКИ A (БОЛЬШАЯ) ---
    if (M5.BtnA.isPressed()) {
        if (!tone_a_is_playing) {
            M5.Speaker.stop(); // Останавливаем любой другой звук
            M5.Speaker.tone(FREQ_A);
            tone_a_is_playing = true;
            tone_b_is_playing = false; // A имеет приоритет
        }
    } else {
        if (tone_a_is_playing) {
            M5.Speaker.stop();
            tone_a_is_playing = false;
        }
    }

    // --- ОБРАБОТКА КНОПКИ B (СБОКУ) ---
    // Сработает, только если кнопка А не зажата
    if (!tone_a_is_playing) {
        if (M5.BtnB.isPressed()) {
            if (!tone_b_is_playing) {
                M5.Speaker.stop();
                M5.Speaker.tone(FREQ_B);
                tone_b_is_playing = true;
            }
        } else {
            if (tone_b_is_playing) {
                M5.Speaker.stop();
                tone_b_is_playing = false;
            }
        }
    }

    // --- ОБРАБОТКА КНОПКИ PWR (ПИТАНИЕ) - КОРОТКОЕ НАЖАТИЕ ---
    if (M5.BtnPWR.wasPressed()) {
        // Останавливаем текущие тона, чтобы проиграть эффект
        if (tone_a_is_playing || tone_b_is_playing) {
             M5.Speaker.stop();
             tone_a_is_playing = false;
             tone_b_is_playing = false;
        }
        // Проигрываем короткий "чирп"
        M5.Speaker.tone(1500, 100); // Частота 1500 Гц на 100 мс
        // После этого, если другие кнопки все еще зажаты,
        // их звук возобновится в следующем цикле loop().
    }
}
